"""
Exercise 3 - CrewAI æ–‡ä»¶åˆ†æç¤ºä¾‹ï¼ˆè§’è‰²åˆ†å·¥ç‰ˆï¼‰

åŠŸèƒ½ï¼š
1. ç”¨çº¯ Python è¯»å–å½“å‰ç›®å½•æ–‡ä»¶ï¼Œç»Ÿè®¡æ–‡ä»¶ç±»å‹ï¼ˆæ‰©å±•åï¼‰å’Œæ•°é‡ï¼Œå¹¶ç”¨è¡¨æ ¼æ‰“å°ã€‚
2. ä½¿ç”¨ CrewAI åˆ›å»º 3 ä¸ªè§’è‰²ï¼š
   - æ–‡ä»¶é‡‡é›†å‘˜ï¼ˆData Fetcherï¼‰
   - æ–‡ä»¶åˆ†æå¸ˆï¼ˆAnalyzerï¼‰
   - æŠ¥å‘Šå‘ˆç°è€…ï¼ˆPresenterï¼‰
   é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œæœ€åç”± Presenter è¾“å‡ºä¸€ä»½â€œæŠ¥å‘Šå¼â€çš„æ€»ç»“ã€‚
3. ä¸è¿›è¡Œä»»ä½•æ–‡ä»¶å†™å…¥æ“ä½œï¼Œåªåœ¨ç»ˆç«¯è¾“å‡ºå†…å®¹ã€‚
"""

from crewai import Agent, Crew, Process, Task, LLM
from dotenv import load_dotenv
from collections import Counter
import os
import traceback

# ============================================================
# 0. åˆå§‹åŒ– & ç¯å¢ƒ
# ============================================================

print("=" * 60)
print("ğŸ“‚ Exercise 3 - CrewAI æ–‡ä»¶åˆ†æå™¨ï¼ˆå¤šæ™ºèƒ½ä½“è§’è‰²ç¤ºä¾‹ï¼‰")
print("=" * 60 + "\n")

load_dotenv()

# ---------------- LLM é…ç½®ï¼ˆæœ¬åœ° DeepSeek ä»£ç†ï¼‰ ----------------
deepseek_llm = LLM(
    model="deepseek-chat",
    base_url="http://localhost:8000/v1",  # ä½ çš„ deepseek adapter åœ°å€
    api_key="dummy",                      # å ä½ç¬¦ï¼Œä»£ç†ä¼šå¿½ç•¥
    temperature=0.3,
)

print("âœ… LLM é…ç½®: deepseek-chat @ http://localhost:8000/v1\n")

# ============================================================
# 1. è¯»å–å½“å‰ç›®å½•æ–‡ä»¶å¹¶ç”¨çº¯ Python ç»Ÿè®¡
# ============================================================

all_entries = os.listdir(".")
files = [f for f in all_entries if os.path.isfile(f)]

print("ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼ˆåŸå§‹æ•°æ®ï¼‰:")
if not files:
    print("  - å½“å‰ç›®å½•ä¸‹æ²¡æœ‰ä»»ä½•æ–‡ä»¶ã€‚\n")
else:
    for f in files:
        print("  -", f)
print()

# å¦‚æœä½ å¸Œæœ›â€œå³ä½¿ LLM å¤±è´¥ä¹Ÿçœ‹åˆ°ç»Ÿè®¡ç»“æœâ€ï¼Œè¿™é‡Œç›´æ¥å…ˆåšä¸€ä»½è¡¨æ ¼ï¼š
if not files:
    file_list_text = "(ç›®å½•ä¸ºç©ºï¼Œæ— æ–‡ä»¶)"
    ext_counter = {}
else:
    file_list_text = "\n".join(files)
    ext_counter = Counter(os.path.splitext(f)[1] or "<æ— æ‰©å±•å>" for f in files)

print("ğŸ“Š [æœ¬åœ°ç»Ÿè®¡] æŒ‰æ‰©å±•åç»Ÿè®¡æ–‡ä»¶æ•°é‡ï¼š\n")
if not ext_counter:
    print("  - æ— æ–‡ä»¶ï¼Œæ— ç»Ÿè®¡æ•°æ®ã€‚\n")
else:
    print("{:<20} {:<10}".format("æ–‡ä»¶ç±»å‹", "æ•°é‡"))
    print("-" * 30)
    for ext, count in ext_counter.items():
        print("{:<20} {:<10}".format(ext, count))
    print()

# ============================================================
# 2. å®šä¹‰ 3 ä¸ªè§’è‰² Agentï¼ˆFetcher / Analyzer / Presenterï¼‰
# ============================================================

file_fetcher = Agent(
    role="æ•°æ®è·å–è€…ï¼ˆFile Fetcherï¼‰",
    goal="æ¥æ”¶å¹¶ç¡®è®¤å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¸é—æ¼ã€ä¸æœæ’°ã€‚",
    verbose=False,
    memory=False,
    backstory=(
        "ä½ è´Ÿè´£ç®¡ç†æ–‡ä»¶æ¸…å•ï¼Œæ“…é•¿æ£€æŸ¥ç›®å½•ä¸­çš„æ–‡ä»¶åç§°ã€‚"
        "ä½ å¿…é¡»ç”¨ä¸­æ–‡äº¤æµï¼Œä¸”ä¸è¦è‡ªå·±åˆ›é€ ä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚"
    ),
    allow_delegation=False,
    llm=deepseek_llm,
)

file_analyzer = Agent(
    role="æ•°æ®åˆ†æè€…ï¼ˆAnalyzerï¼‰",
    goal="æ ¹æ®æ–‡ä»¶åˆ—è¡¨ç»Ÿè®¡ä¸åŒç±»å‹æ–‡ä»¶çš„æ•°é‡ï¼Œå¹¶ç»™å‡ºç®€è¦åˆ†æã€‚",
    verbose=False,
    memory=False,
    backstory=(
        "ä½ æ˜¯ç»éªŒä¸°å¯Œçš„æ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿ä»åŸå§‹åˆ—è¡¨ä¸­æå–ç»“æ„åŒ–ç»Ÿè®¡ä¿¡æ¯ï¼Œ"
        "ä¼šå…³æ³¨æ–‡ä»¶æ‰©å±•åå¹¶ç»Ÿè®¡æ¯ä¸€ç±»çš„æ•°é‡ã€‚"
    ),
    allow_delegation=False,
    llm=deepseek_llm,
)

report_presenter = Agent(
    role="æŠ¥å‘Šå‘ˆç°è€…ï¼ˆPresenterï¼‰",
    goal="å°†åˆ†æç»“æœæ•´ç†æˆæ¸…æ™°çš„æŠ¥å‘Šï¼Œç”¨è¡¨æ ¼å’Œç®€æ´ä¸­æ–‡æ€»ç»“ã€‚",
    verbose=False,
    memory=False,
    backstory=(
        "ä½ æ“…é•¿æŠŠå¤æ‚ä¿¡æ¯æ•´ç†æˆå¯è¯»æ€§å¼ºçš„æŠ¥å‘Šå’Œè¡¨æ ¼ï¼Œ"
        "ä¼šä½¿ç”¨ Markdown æˆ–ç­‰å®½æ–‡æœ¬è¡¨æ ¼ï¼Œè®©è¾“å‡ºæ¸…æ™°æ˜“è¯»ã€‚"
    ),
    allow_delegation=False,
    llm=deepseek_llm,
)

print("âœ… å·²åˆ›å»ºæ™ºèƒ½ä½“: File Fetcher + Analyzer + Presenter\n")

# ============================================================
# 3. å®šä¹‰ Task é¡ºåºï¼šFetcher â†’ Analyzer â†’ Presenter
# ============================================================

# Task 1ï¼šFetcher ç¡®è®¤å¹¶æ¦‚æ‹¬æ–‡ä»¶åˆ—è¡¨
fetch_task = Task(
    description=(
        "ä¸‹é¢æ˜¯å½“å‰å·¥ä½œç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨ï¼š\n\n"
        "{file_list}\n\n"
        "è¯·ä½ å®Œæˆä¸¤ä»¶äº‹ï¼š\n"
        "1. ç¡®è®¤ä½ å·²ç»æ”¶åˆ°å¹¶ç†è§£è¿™ä»½æ–‡ä»¶åˆ—è¡¨ï¼Œä¸è¦æ·»åŠ æ–°æ–‡ä»¶åï¼›\n"
        "2. ç”¨ 1ï½2 å¥è¯ä¸­æ–‡æ¦‚æ‹¬ï¼šè¿™ä¸ªç›®å½•å¤§è‡´æ˜¯ä»€ä¹ˆç±»å‹çš„é¡¹ç›®ï¼ˆä¾‹å¦‚ï¼šPython è„šæœ¬å¤šã€æ–‡æ¡£å¤šç­‰ï¼‰ã€‚"
    ),
    expected_output="ç®€çŸ­ä¸­æ–‡è¯´æ˜ï¼Œç¡®è®¤æ”¶åˆ°æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶ç»™å‡ºä¸€æ®µæ•´ä½“æ¦‚æ‹¬ã€‚",
    agent=file_fetcher,
)

# Task 2ï¼šAnalyzer ç»Ÿè®¡ç±»å‹æ•°é‡
analyze_task = Task(
    description=(
        "åŸºäºè¿™ä»½æ–‡ä»¶åˆ—è¡¨ï¼š\n\n"
        "{file_list}\n\n"
        "è¯·ä½ æŒ‰æ–‡ä»¶æ‰©å±•åï¼ˆä¾‹å¦‚ .pyã€.txtã€.mdã€æ— æ‰©å±•åç­‰ï¼‰ç»Ÿè®¡æ–‡ä»¶æ•°é‡ã€‚\n"
        "è¦æ±‚ï¼š\n"
        "1. åˆ—å‡ºæ¯ç§æ‰©å±•ååŠå¯¹åº”æ•°é‡ï¼›\n"
        "2. ç»™å‡ºä¸€å¥æ•´ä½“æ€»ç»“ï¼Œä¾‹å¦‚â€œPython æ–‡ä»¶å å¤šæ•°â€ç­‰ã€‚\n"
        "è¾“å‡ºä½¿ç”¨ç®€æ´ä¸­æ–‡ï¼Œç»“æ„åŒ–åˆ—å‡ºç»Ÿè®¡ç»“æœã€‚"
    ),
    expected_output="åˆ—å‡ºâ€œæ‰©å±•å - æ•°é‡â€çš„ç»Ÿè®¡åˆ—è¡¨ï¼Œå¹¶é™„ä¸€å°æ®µä¸­æ–‡æ€»ç»“ã€‚",
    agent=file_analyzer,
)

# Task 3ï¼šPresenter è¾“å‡ºæŠ¥å‘Šï¼ˆè¡¨æ ¼+æ€»ç»“ï¼‰
present_task = Task(
    description=(
        "ä½ ä¼šæ‹¿åˆ°ä¸Šä¸€ä»»åŠ¡è¿”å›çš„â€œæ‰©å±•å - æ•°é‡â€ç»Ÿè®¡ç»“æœã€‚\n"
        "è¯·ä½ ï¼š\n"
        "1. å°†è¿™äº›ç»Ÿè®¡ä¿¡æ¯æ•´ç†æˆä¸€å¼ è¡¨æ ¼ï¼›\n"
        "2. å¯ä½¿ç”¨ Markdown è¡¨æ ¼æˆ–ç­‰å®½æ–‡æœ¬è¡¨æ ¼ï¼›\n"
        "3. è¡¨å¤´å»ºè®®ä¸ºï¼šæ–‡ä»¶ç±»å‹ã€æ•°é‡ï¼›\n"
        "4. åœ¨è¡¨æ ¼ä¸‹æ–¹ï¼Œå†ç»™å‡º 1ï½2 å¥è‡ªç„¶è¯­è¨€æ€»ç»“ç›®å½•ç‰¹ç‚¹ã€‚"
    ),
    expected_output="ä¸€å¼ è¡¨æ ¼ + 1ï½2 å¥ä¸­æ–‡æ€»ç»“ã€‚",
    agent=report_presenter,
)

print("âœ… å·²åˆ›å»ºä»»åŠ¡: Fetch â†’ Analyze â†’ Present\n")

# ============================================================
# 4. åˆ›å»º Crew å¹¶æ‰§è¡Œé¡ºåºä»»åŠ¡
# ============================================================

crew = Crew(
    agents=[file_fetcher, file_analyzer, report_presenter],
    tasks=[fetch_task, analyze_task, present_task],
    process=Process.sequential,
    memory=False,
    cache=False,
    max_rpm=100,
    share_crew=True,
    verbose=False,
)

print("âœ… å·²åˆ›å»ºå›¢é˜Ÿ: 3 ä¸ªæ™ºèƒ½ä½“, 3 ä¸ªä»»åŠ¡, é¡ºåºæ‰§è¡Œ\n")

print("=" * 60)
print("ğŸš€ å¼€å§‹æ‰§è¡Œ CrewAI æµç¨‹ï¼ˆFetcher â†’ Analyzer â†’ Presenterï¼‰")
print("=" * 60 + "\n")

result = None
try:
    # æŠŠçœŸå®çš„æ–‡ä»¶åˆ—è¡¨ä¼ å…¥ {file_list}
    result = crew.kickoff(inputs={"file_list": file_list_text})
except Exception as e:
    print("âŒ æ‰§è¡Œ crew.kickoff æ—¶å‘ç”Ÿé”™è¯¯ï¼š")
    print(e)
    print("\nğŸ” è¯¦ç»† Tracebackï¼š")
    traceback.print_exc()

# ============================================================
# 5. æ˜¾ç¤º Presenter çš„æœ€ç»ˆæŠ¥å‘Š
# ============================================================

print("\n" + "=" * 60)
print("ğŸ“Š [CrewAI æŠ¥å‘Šå‘ˆç°è€…] æ–‡ä»¶ç±»å‹ç»Ÿè®¡æŠ¥å‘Š")
print("=" * 60 + "\n")

if result is None:
    print("âš  æœªè·å–åˆ° CrewAI çš„ç»“æœï¼ˆå¯èƒ½åœ¨è°ƒç”¨ LLM è¿‡ç¨‹ä¸­å‡ºé”™ï¼‰ã€‚")
else:
    print(result)

print("\n" + "=" * 60)
print("âœ… ç¨‹åºç»“æŸï¼š")
print(" - å·²ç”¨æœ¬åœ° Python æ‰“å°æ–‡ä»¶ç±»å‹ç»Ÿè®¡è¡¨")
print(" - å·²å°è¯•é€šè¿‡ CrewAI æ‰§è¡Œä¸‰è§’è‰²ä»»åŠ¡å¹¶ç”ŸæˆæŠ¥å‘Š")
print("=" * 60 + "\n")
