# i6exercise4_groupchat_autogen.py
"""
Exercise 4 - Multi-Agent Collaboration in Group Chat Using AutoGen

åŠŸèƒ½ï¼š
- ä½¿ç”¨ AutoGen çš„ GroupChat å®ç°å¤šæ™ºèƒ½ä½“åä½œ
- åœºæ™¯ï¼šä¸ºä¸€æ¬¡å•†åŠ¡æ—…è¡Œåˆ¶å®šè¯¦ç»†è¡Œç¨‹ï¼ˆè¡Œç¨‹è§„åˆ’é—®é¢˜ï¼‰
- å¤šä¸ª Agent åœ¨ç¾¤èŠä¸­äº’ç›¸æé—®ã€è¡¥å……ã€æ›´æ–°ä¿¡æ¯
- ä½¿ç”¨æœ¬åœ° DeepSeek / OpenAI å…¼å®¹æ¥å£ï¼ˆé€šè¿‡ OAI_CONFIG_LISTï¼‰

å‰æï¼š
1. å·²å®‰è£… autogen
2. å·²åœ¨ç¯å¢ƒæˆ– OAI_CONFIG_LIST ä¸­é…ç½®å¥½æœ¬åœ° deepseek ä»£ç†ï¼Œå¦‚ï¼š
   [
     {
       "model": "deepseek-chat",
       "api_key": "dummy",
       "base_url": "http://localhost:8000/v1"
     }
   ]
"""

from autogen import (
    AssistantAgent,
    UserProxyAgent,
    GroupChat,
    GroupChatManager,
    config_list_from_json,
)
from textwrap import dedent
import os

# ============================================================
# åˆå§‹åŒ–ä¸ LLM é…ç½®
# ============================================================

print("=" * 60)
print("ğŸ§³ Exercise 4 - AutoGen å•†åŠ¡æ—…è¡Œè¡Œç¨‹è§„åˆ’ï¼ˆGroup Chat å¤šæ™ºèƒ½ä½“åä½œï¼‰")
print("=" * 60)
print(f"ğŸ“… å½“å‰æ—¶é—´ï¼ˆå‡å®šï¼‰: {os.getenv('CURRENT_DATETIME', '2025-11-23 10:00:00')}")
print(f"ğŸ‘¤ å½“å‰ç”¨æˆ·: {os.getenv('CURRENT_USER', 'greatabel')}")
print("=" * 60 + "\n")

# ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ä¸­åŠ è½½ OpenAI/DeepSeek å…¼å®¹é…ç½®
config_list = config_list_from_json(env_or_file="OAI_CONFIG_LIST")

llm_config = {
    "config_list": config_list,
    "temperature": 0.4,  # ç¨å¾®ç†æ€§ä¸€ç‚¹
}

print("âœ… å·²åŠ è½½ LLM é…ç½®ï¼ˆæ¥è‡ª OAI_CONFIG_LISTï¼‰\n")

# ============================================================
# å®šä¹‰ UserProxyï¼ˆä»£è¡¨çœŸå®ç”¨æˆ·ï¼‰
# ============================================================

user_proxy = UserProxyAgent(
    name="user",
    human_input_mode="TERMINATE",  # ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è¾“å…¥å†…å®¹ï¼›è¾“å…¥ä»¥ TERMINATE ç»“å°¾å¯ä¸­æ­¢
    code_execution_config={
        "work_dir": "working",
        "use_docker": False,
    },
    is_termination_msg=lambda x: x.get("content", "").rstrip().endswith("TERMINATE"),
    max_consecutive_auto_reply=10,
)

# ============================================================
# å®šä¹‰å¤šä¸ªåä½œ Agentï¼ˆä¸åŒè§’è‰²ï¼‰
# ============================================================

# 1ï¸âƒ£ ç›®çš„åœ° & äº¤é€šä¸“å®¶
travel_expert = AssistantAgent(
    name="TravelExpert",
    system_message=dedent(
        """
        ä½ æ˜¯èµ„æ·±å•†åŠ¡æ—…è¡Œé¡¾é—®ï¼Œä¸“é•¿æ˜¯ï¼š
        - æ ¹æ®å‡ºå‘åœ°ã€ç›®çš„åœ°å’Œæ—¥æœŸï¼Œè®¾è®¡åˆç†çš„äº¤é€šæ–¹æ¡ˆï¼ˆèˆªç­/é«˜é“/æœºåœºäº¤é€šç­‰ï¼‰
        - æé†’ç­¾è¯ã€æ—¶å·®ã€å¤©æ°”ç­‰æ³¨æ„äº‹é¡¹
        åœ¨ç¾¤èŠä¸­ï¼Œä½ è¦ï¼š
        - ä¸»åŠ¨å‘å…¶ä»– Agent æé—®ï¼ˆä¾‹å¦‚é¢„ç®—é™åˆ¶ã€é…’åº—éœ€æ±‚ï¼‰
        - æ ¹æ®ä»–ä»¬çš„ä¿¡æ¯ï¼Œè°ƒæ•´äº¤é€šä¸æ•´ä½“èŠ‚å¥å®‰æ’
        æ‰€æœ‰è¾“å‡ºå¿…é¡»ä½¿ç”¨ä¸­æ–‡ã€‚
        """
    ),
    llm_config=llm_config,
)

# 2ï¸âƒ£ é…’åº—ä¸ä½å®¿ä¸“å®¶
hotel_expert = AssistantAgent(
    name="HotelExpert",
    system_message=dedent(
        """
        ä½ æ˜¯å•†åŠ¡å‡ºå·®é…’åº—ä¸ä½å®¿ä¸“å®¶ï¼Œæ“…é•¿ï¼š
        - æ ¹æ®ç›®çš„åœ°å’Œé¢„ç®—ï¼Œæ¨èå•†åŠ¡å‡ºå·®å¸¸ç”¨çš„åŒºåŸŸå’Œé…’åº—ç±»å‹
        - å¹³è¡¡é€šå‹¤æ—¶é—´ã€èˆ’é€‚åº¦ä¸ä»·æ ¼
        åœ¨ç¾¤èŠä¸­ï¼Œä½ è¦ï¼š
        - æ ¹æ® TravelExpert çš„è¡Œç¨‹èŠ‚å¥ï¼Œå®‰æ’åˆé€‚çš„ä½å®¿ä½ç½®ï¼ˆä¾‹å¦‚é è¿‘ä¼šè®®åœ°ç‚¹ï¼‰
        - å‘ BudgetAdvisor è¯¢é—®ä»·æ ¼åŒºé—´ï¼Œé¿å…é¢„ç®—è¶…æ ‡
        è¾“å‡ºå¿…é¡»æ˜¯ä¸­æ–‡ã€‚
        """
    ),
    llm_config=llm_config,
)

# 3ï¸âƒ£ é¢„ç®—ä¸æ€§ä»·æ¯”é¡¾é—®
budget_advisor = AssistantAgent(
    name="BudgetAdvisor",
    system_message=dedent(
        """
        ä½ æ˜¯é¢„ç®—ä¸è´¹ç”¨æ§åˆ¶é¡¾é—®ï¼Œæ“…é•¿ï¼š
        - æ ¹æ®æ€»é¢„ç®—ï¼Œåˆ†é…äº¤é€šã€ä½å®¿ã€é¤é¥®å’Œå¤‡ç”¨é‡‘
        - æŒ‡å‡ºå¯èƒ½è¶…æ”¯çš„éƒ¨åˆ†å¹¶ç»™å‡ºæ›¿ä»£æ–¹æ¡ˆ
        åœ¨ç¾¤èŠä¸­ï¼Œä½ è¦ï¼š
        - å®¡é˜… TravelExpert å’Œ HotelExpert çš„å»ºè®®
        - æŒ‡å‡ºå“ªäº›å®‰æ’ä»·æ ¼å¯èƒ½åé«˜ï¼Œå¹¶æå‡ºæ›´åˆ’ç®—çš„è°ƒæ•´å»ºè®®
        è¾“å‡ºå¿…é¡»æ˜¯ä¸­æ–‡ï¼Œå¹¶åŒ…å«ç®€å•çš„è´¹ç”¨ä¼°ç®—ï¼ˆå¤§è‡´åŒºé—´å³å¯ï¼‰ã€‚
        """
    ),
    llm_config=llm_config,
)

print("âœ… å·²åˆ›å»º 3 ä¸ªåä½œ Agentï¼šTravelExpert / HotelExpert / BudgetAdvisor\n")

# ============================================================
# åˆ›å»º GroupChat & GroupChatManagerï¼ˆç¾¤èŠç®¡ç†å™¨ï¼‰
# ============================================================

group_chat = GroupChat(
    agents=[user_proxy, travel_expert, hotel_expert, budget_advisor],
    messages=[],
    max_round=1,  # æœ€å¤šè½®æ•°ï¼Œé˜²æ­¢æ— é™èŠå¤©
)

manager = GroupChatManager(
    groupchat=group_chat,
    llm_config=llm_config,
    system_message=dedent(
        """
        ä½ æ˜¯ GroupChatManagerï¼Œè´Ÿè´£åè°ƒå¤šä¸ª Agent çš„å¯¹è¯ã€‚
        ç›®æ ‡ï¼šä¸ºç”¨æˆ·åˆ¶å®šä¸€ä»½å¯æ‰§è¡Œçš„å•†åŠ¡æ—…è¡Œè¡Œç¨‹ã€‚
        
        åè°ƒå‡†åˆ™ï¼š
        1. è®© TravelExpert å…ˆç»™å‡ºæ•´ä½“è¡Œç¨‹æ¡†æ¶ä¸äº¤é€šæ–¹æ¡ˆå»ºè®®ã€‚
        2. æ¥ç€è®© HotelExpert åŸºäºè¡Œç¨‹èŠ‚å¥è¡¥å……ä½å®¿å»ºè®®ã€‚
        3. ç„¶åç”± BudgetAdvisor è¯„ä¼°æ•´ä½“èŠ±è´¹ï¼Œå¹¶ç»™å‡ºé¢„ç®—ä¸Šçš„è°ƒæ•´å»ºè®®ã€‚
        4. æœ€åï¼Œä½ éœ€è¦ç»„ç»‡ä¸€ä»½â€œæœ€ç»ˆæ±‡æ€»â€ï¼ŒåŒ…å«ï¼š
           - æŒ‰å¤©åˆ’åˆ†çš„è¯¦ç»†è¡Œç¨‹ï¼ˆDay 1, Day 2, ...ï¼‰
           - æ¯å¤©çš„ä¸»è¦æ´»åŠ¨ã€äº¤é€šå’Œä½å®¿
           - å¤§è‡´è´¹ç”¨ç»“æ„å’Œé¢„ç®—æé†’
        æ‰€æœ‰å†…å®¹å¿…é¡»ä½¿ç”¨ä¸­æ–‡è¾“å‡ºã€‚
        """
    ),
)

print("âœ… å·²åˆ›å»º GroupChat ä¸ GroupChatManagerï¼ˆå·²å¯ç”¨å¤š Agent ç¾¤èŠåä½œï¼‰\n")

# ============================================================
# æ”¶é›†ç”¨æˆ·è¾“å…¥ï¼šå‡ºå‘åœ°ã€ç›®çš„åœ°ã€æ—¥æœŸã€é¢„ç®—
# ============================================================

print("ğŸ§¾ è¯·è¾“å…¥æœ¬æ¬¡å•†åŠ¡æ—…è¡Œçš„åŸºæœ¬ä¿¡æ¯ï¼ˆç›´æ¥å›è½¦å¯ä½¿ç”¨é»˜è®¤ç¤ºä¾‹ï¼‰ï¼š\n")

origin = input("å‡ºå‘åŸå¸‚ï¼ˆä¾‹å¦‚ï¼šä¸Šæµ·ï¼‰ï¼š ").strip()
if not origin:
    origin = "ä¸Šæµ·"

destination = input("ç›®çš„åœ°åŸå¸‚ï¼ˆä¾‹å¦‚ï¼šæ–°åŠ å¡ï¼‰ï¼š ").strip()
if not destination:
    destination = "æ–°åŠ å¡"

start_date = input("å‡ºå‘æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2025-12-01ï¼‰ï¼š ").strip()
if not start_date:
    start_date = "2025-12-01"

end_date = input("è¿”å›æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2025-12-05ï¼‰ï¼š ").strip()
if not end_date:
    end_date = "2025-12-05"

budget = input("æ€»é¢„ç®—ï¼ˆä¾‹å¦‚ï¼š15000 äººæ°‘å¸ï¼‰ï¼š ").strip()
if not budget:
    budget = "15000 äººæ°‘å¸"

print("\n" + "=" * 60)
print("ğŸš€ å¼€å§‹å¤šæ™ºèƒ½ä½“ç¾¤èŠåä½œè§„åˆ’å•†åŠ¡è¡Œç¨‹ ...")
print("=" * 60 + "\n")

# æ„é€ åˆå§‹ä»»åŠ¡è¯´æ˜ï¼ˆç”± user_proxy å‘ç»™ç¾¤èŠï¼‰
task = dedent(
    f"""
    è¯·ä½ ä»¬å…±åŒä¸ºæˆ‘è§„åˆ’ä¸€è¶Ÿå•†åŠ¡æ—…è¡Œè¡Œç¨‹ï¼Œå…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š

    - å‡ºå‘åŸå¸‚ï¼š{origin}
    - ç›®çš„åœ°åŸå¸‚ï¼š{destination}
    - å‡ºå‘æ—¥æœŸï¼š{start_date}
    - è¿”å›æ—¥æœŸï¼š{end_date}
    - æ€»é¢„ç®—ï¼š{budget}

    éœ€æ±‚ï¼š
    1. è¿™æ˜¯ä¸€æ¬¡ä»¥å•†åŠ¡ä¼šè®®ä¸ºä¸»çš„å‡ºå·®è¡Œç¨‹ï¼Œå¸Œæœ›ï¼š
       - ç™½å¤©ä»¥ä¼šè®®ã€å®¢æˆ·æ‹œè®¿ä¸ºä¸»
       - æ™šä¸Šå¯ä»¥å®‰æ’å°‘é‡è½»åº¦çš„æœ¬åœ°ä½“éªŒæˆ–å•†åŠ¡æ™šé¤
    2. è¯·å…ˆåœ¨ä½ ä»¬ä¹‹é—´è®¨è®ºå¹¶åˆ†å·¥ï¼š
       - TravelExpertï¼šè´Ÿè´£æ•´ä½“èŠ‚å¥è®¾è®¡å’Œäº¤é€šæ–¹å¼å»ºè®®ï¼›
       - HotelExpertï¼šæ¨èåˆé€‚çš„ä½å®¿åŒºåŸŸå’Œé…’åº—ç±»å‹ï¼›
       - BudgetAdvisorï¼šæ§åˆ¶æ•´ä½“èŠ±è´¹ï¼Œå¹¶åœ¨å¿…è¦æ—¶æå‡ºâ€œèŠ‚çœæˆæœ¬â€çš„æ›¿ä»£æ–¹æ¡ˆã€‚
    3. æœ€ç»ˆç”± GroupChatManager è¾“å‡ºä¸€ä¸ªâ€œæ±‡æ€»æ–¹æ¡ˆâ€ï¼ŒåŒ…æ‹¬ï¼š
       - æ¯ä¸€å¤©çš„è¯¦ç»†è¡Œç¨‹ï¼ˆä»¥ Day 1, Day 2 å½¢å¼åˆ†ç‚¹åˆ—å‡ºï¼‰ï¼›
       - æ¯å¤©çš„ä¸»è¦æ´»åŠ¨ã€äº¤é€šæ–¹å¼å’Œä½å®¿å»ºè®®ï¼›
       - å¤§è‡´è´¹ç”¨çš„æ‹†åˆ†ï¼ˆäº¤é€š / ä½å®¿ / å…¶ä»–ï¼‰ï¼Œä¸éœ€è¦éå¸¸ç²¾ç¡®ï¼Œåªè¦åˆç†ä¼°ç®—ã€‚

    è¯·å¼€å§‹ä½ ä»¬çš„åä½œè®¨è®ºï¼Œæœ€ç»ˆç»™å‡ºæ¸…æ™°çš„è¡Œç¨‹è®¡åˆ’ã€‚
    """
)

# ============================================================
# å¯åŠ¨ç¾¤èŠï¼šUserProxy å‘ GroupChatManager å‘èµ·å¯¹è¯
# ============================================================

result = user_proxy.initiate_chat(
    recipient=manager,
    message=task,
    max_turns=1,          # æœ€å¤šè½®æ•°ï¼ˆåŒ…æ‹¬ä¸­é—´ä»£ç†ä¹‹é—´çš„å¯¹è¯ï¼‰
    summary_method="last_msg",  # åªè¿”å›æœ€åçš„æ±‡æ€»æ¶ˆæ¯
)

# ============================================================
# æ‰“å°æœ€ç»ˆç»“æœ
# ============================================================

print("\n" + "=" * 60)
print("ğŸ“Š æœ€ç»ˆå•†åŠ¡æ—…è¡Œè¡Œç¨‹è§„åˆ’ï¼ˆæ¥è‡ª GroupChat åä½œï¼‰")
print("=" * 60 + "\n")
print(result)
print("\n" + "=" * 60)
print("âœ… Exercise 4 å®Œæˆï¼šå·²ä½¿ç”¨ AutoGen GroupChat å®ç°å¤š Agent åä½œã€‚")
print("=" * 60 + "\n")
print("ğŸ’¡ æç¤ºï¼šä½ å¯ä»¥å¤šæ¬¡è¿è¡Œï¼Œä¿®æ”¹åŸå¸‚/æ—¥æœŸ/é¢„ç®—ï¼Œè§‚å¯Ÿå¤šæ™ºèƒ½ä½“åä½œè¡Œä¸ºçš„å˜åŒ–ã€‚")
