# crewai_joke_chinese.py
"""
CrewAI 笑话生成器 - 中文版

功能：
- 使用本地 DeepSeek API
- 禁用记忆功能（避免 404 错误）
- 全中文界面

前提：
1. DeepSeek 代理服务器运行在 http://localhost:8000
2. .env 文件已配置
"""

from crewai import Agent, Crew, Process, Task, LLM
from dotenv import load_dotenv
import os

# ============================================================
# 初始化
# ============================================================

print("="*60)
print(f"🤖 CrewAI 笑话生成器（中文版）")
print("="*60)
print(f"📅 当前日期时间（UTC）: 2025-11-20 07:38:10")
print(f"👤 当前用户登录名: greatabel")
print()

# 加载环境变量
load_dotenv()

# ============================================================
# 配置 LLM（大语言模型）
# ============================================================
# 通俗解释：
# - 这是告诉 CrewAI 使用我们本地的 DeepSeek API
# - base_url 指向本地代理服务器
# - api_key 设为 "dummy"（代理服务器会替换成真实的）
# ============================================================

deepseek_llm = LLM(
    model="deepseek-chat",                    # 模型名称
    base_url="http://localhost:8000/v1",      # 本地代理地址
    api_key="dummy",                          # 占位符（代理会替换）
    temperature=0.8,                          # 温度（越高越有创意）
)

print("✅ LLM 配置完成:")
print(f"   模型: deepseek-chat")
print(f"   地址: http://localhost:8000/v1")
print(f"   温度: 0.8 (较高创意)")
print()

# ============================================================
# 创建智能体（Agents）
# ============================================================
# 通俗解释：
# - Agent = 一个有特定角色和目标的 AI 助手
# - 就像一个团队，每个人有自己的职责
# ============================================================

# ------------------------------------------------------------
# 智能体 1：笑话研究员
# ------------------------------------------------------------
# 职责：研究什么东西好笑，为什么好笑
# 特点：可以把任务委派给其他智能体
# ------------------------------------------------------------

joke_researcher = Agent(
    role="资深笑话研究员",
    goal="研究以下主题为什么好笑：{topic}",
    verbose=True,        # 显示详细过程
    memory=False,        # ⭐ 禁用记忆（避免 404 错误）
    backstory=(
        "你是一位经验丰富的笑话研究员，精通各种幽默类型。"
        "你擅长发现日常生活中的笑点，能把平淡的时刻变成笑料。"
        "你对喜剧理论有深入研究，了解什么能让人发笑。"
    ),
    allow_delegation=True,   # 允许委派任务
    llm=deepseek_llm,       # 使用本地 DeepSeek
)

print("✅ 已创建智能体：笑话研究员")
print(f"   角色: 资深笑话研究员")
print(f"   特点: 可以委派任务给其他智能体")
print()

# ------------------------------------------------------------
# 智能体 2：笑话作家
# ------------------------------------------------------------
# 职责：根据研究员的发现，创作笑话
# 特点：不能委派任务，专注于写作
# ------------------------------------------------------------

joke_writer = Agent(
    role="笑话作家",
    goal="创作一个关于以下主题的幽默笑话：{topic}",
    verbose=True,
    memory=False,        # ⭐ 禁用记忆
    backstory=(
        "你是一位才华横溢的笑话作家，擅长用文字制造笑料。"
        "你能把简单的想法变成让人捧腹大笑的段子。"
        "你的文字功底深厚，几句话就能逗笑观众。"
    ),
    allow_delegation=False,  # 不允许委派（专注写作）
    llm=deepseek_llm,
)

print("✅ 已创建智能体：笑话作家")
print(f"   角色: 笑话作家")
print(f"   特点: 专注于创作，不委派任务")
print()

# ============================================================
# 创建任务（Tasks）
# ============================================================
# 通俗解释：
# - Task = 要完成的具体工作
# - 每个任务分配给一个智能体
# ============================================================

# ------------------------------------------------------------
# 任务 1：研究任务
# ------------------------------------------------------------
# 目标：分析主题为什么好笑
# 负责人：笑话研究员
# ------------------------------------------------------------

research_task = Task(
    description=(
        "分析以下主题为什么好笑：{topic}。"
        "请务必包含以下内容："
        "1. 让这个主题幽默的关键要素"
        "2. 当前社会趋势分析"
        "3. 这些趋势如何影响人们对幽默的感知"
    ),
    expected_output="一份 3 段落的详细报告，分析该主题的幽默要素。",
    agent=joke_researcher,
)

print("✅ 已创建任务：研究任务")
print(f"   负责人: 笑话研究员")
print(f"   预期输出: 3 段落分析报告")
print()

# ------------------------------------------------------------
# 任务 2：写作任务
# ------------------------------------------------------------
# 目标：创作笑话
# 负责人：笑话作家
# ------------------------------------------------------------

write_task = Task(
    description=(
        "创作一个关于 {topic} 的幽默笑话。"
        "要求："
        "1. 富有洞察力"
        "2. 幽默风趣"
        "3. 与当前社会趋势相关"
        "4. 包含让人发笑的关键要素"
    ),
    expected_output="一个简洁的一句话笑话，主题是 {topic}。",
    agent=joke_writer,
    async_execution=False,           # 不异步执行（按顺序）
    output_file="最佳笑话.md",       # ⭐ 输出到文件
)

print("✅ 已创建任务：写作任务")
print(f"   负责人: 笑话作家")
print(f"   预期输出: 一句话笑话")
print(f"   输出文件: 最佳笑话.md")
print()

# ============================================================
# 创建团队（Crew）
# ============================================================
# 通俗解释：
# - Crew = 整个团队，包含所有智能体和任务
# - process=Process.sequential 表示任务按顺序执行
#   （先研究，后写作）
# ============================================================

crew = Crew(
    agents=[joke_researcher, joke_writer],   # 团队成员
    tasks=[research_task, write_task],       # 任务列表
    process=Process.sequential,              # 顺序执行任务
    memory=False,                            # ⭐ 禁用团队记忆
    cache=False,                             # ⭐ 禁用缓存（简化）
    max_rpm=100,                             # 每分钟最大请求数
    share_crew=True,                         # 共享团队信息
    verbose=True,                            # 显示详细日志
)

print("✅ 已创建团队:")
print(f"   成员数: 2 个智能体")
print(f"   任务数: 2 个任务")
print(f"   执行模式: 顺序执行")
print(f"   记忆功能: 已禁用（避免错误）")
print()

# ============================================================
# 定义主题
# ============================================================

topic = "AI 工程师"

print("📋 笑话主题:")
print(f"   {topic}")
print()

# ============================================================
# 启动团队执行任务
# ============================================================
# 通俗解释：
# - kickoff() = 启动团队，开始工作
# - 输入主题，团队会按顺序完成所有任务
# ============================================================

print("="*60)
print("🚀 开始执行任务...")
print("="*60)
print()

print("提示：")
print("  - 研究员会先分析主题")
print("  - 作家会根据分析创作笑话")
print("  - 整个过程可能需要 30-60 秒")
print()

result = crew.kickoff(inputs={"topic": topic})

# ============================================================
# 显示结果
# ============================================================

print()
print("="*60)
print("📊 最终结果")
print("="*60)
print()

# 打印返回的笑话
print("🎭 生成的笑话:")
print("-"*60)
print(result)
print("-"*60)
print()

# 检查并显示输出文件
output_file = "最佳笑话.md"
if os.path.exists(output_file):
    print(f"✅ 笑话已保存到文件: {output_file}")
    print()
    print("📄 文件内容:")
    print("-"*60)
    with open(output_file, "r", encoding="utf-8") as f:
        content = f.read()
        print(content)
    print("-"*60)
else:
    print(f"⚠️  输出文件未找到: {output_file}")

print()
print("="*60)
print("✅ 任务完成！")
print("="*60)
print()

# ============================================================
# 额外信息
# ============================================================

print("💡 提示:")
print("  - 重新运行此脚本会生成新的笑话")
print("  - 修改 'topic' 变量可以更改笑话主题")
print("  - 查看 '最佳笑话.md' 文件获取输出")
print()