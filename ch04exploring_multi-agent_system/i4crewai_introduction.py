# crewai_joke_chinese_compact.py
"""
CrewAI ç¬‘è¯ç”Ÿæˆå™¨ - ä¸­æ–‡ç²¾ç®€ç‰ˆ

åŠŸèƒ½ï¼šä½¿ç”¨æœ¬åœ° DeepSeek API ç”Ÿæˆå¹½é»˜ç¬‘è¯
å‰æï¼šDeepSeek ä»£ç†æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:8000
"""

from crewai import Agent, Crew, Process, Task, LLM
from dotenv import load_dotenv
import os

# ============================================================
# åˆå§‹åŒ–ä¸é…ç½®
# ============================================================

print("="*60)
print(f"ğŸ¤– CrewAI ç¬‘è¯ç”Ÿæˆå™¨ï¼ˆä¸­æ–‡ç‰ˆï¼‰\n"
      f"ğŸ“… å½“å‰æ—¥æœŸæ—¶é—´ï¼ˆUTCï¼‰: {os.getenv('CURRENT_DATETIME', '2025-11-20 07:52:08')}\n"
      f"ğŸ‘¤ å½“å‰ç”¨æˆ·: {os.getenv('CURRENT_USER', 'greatabel')}")
print("="*60 + "\n")

load_dotenv()  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆAPI Key ç­‰ï¼‰

# é…ç½® LLMï¼šå‘Šè¯‰ CrewAI ä½¿ç”¨æœ¬åœ° DeepSeek API
# - model: æ¨¡å‹åç§°
# - base_url: æœ¬åœ°ä»£ç†æœåŠ¡å™¨åœ°å€
# - api_key: å ä½ç¬¦ï¼ˆä»£ç†ä¼šæ›¿æ¢ä¸ºçœŸå® Keyï¼‰
# - temperature: æ§åˆ¶åˆ›æ„ç¨‹åº¦ï¼ˆ0=ä¿å®ˆï¼Œ1=æå¯Œåˆ›æ„ï¼‰
deepseek_llm = LLM(
    model="deepseek-chat",
    base_url="http://localhost:8000/v1",
    api_key="dummy",
    temperature=0.8,  # è¾ƒé«˜åˆ›æ„
)

print("âœ… LLM é…ç½®: deepseek-chat @ http://localhost:8000/v1 (æ¸©åº¦: 0.8)\n")

# ============================================================
# åˆ›å»ºæ™ºèƒ½ä½“ï¼ˆAgentsï¼‰
# ============================================================
# Agent = å…·æœ‰ç‰¹å®šè§’è‰²å’Œç›®æ ‡çš„ AI åŠ©æ‰‹
# ç±»æ¯”ï¼šä¸€ä¸ªå¼€å‘å›¢é˜Ÿä¸­çš„ä¸åŒèŒä½

# ç¬‘è¯ç ”ç©¶å‘˜ï¼šåˆ†æä¸»é¢˜ä¸ºä»€ä¹ˆå¥½ç¬‘
# - verbose=False: ç¦ç”¨è¯¦ç»†æ—¥å¿—ï¼ˆå‡å°‘è¾“å‡ºï¼‰
# - memory=False: ç¦ç”¨è®°å¿†åŠŸèƒ½ï¼ˆé¿å… Embeddings API 404 é”™è¯¯ï¼‰
# - allow_delegation=True: å¯ä»¥å°†å­ä»»åŠ¡å§”æ´¾ç»™å…¶ä»–æ™ºèƒ½ä½“
joke_researcher = Agent(
    role="èµ„æ·±ç¬‘è¯ç ”ç©¶å‘˜",
    goal="ç ”ç©¶ä»¥ä¸‹ä¸»é¢˜ä¸ºä»€ä¹ˆå¥½ç¬‘ï¼š{topic}",
    verbose=False,
    memory=False,
    backstory="ä½ æ˜¯ç»éªŒä¸°å¯Œçš„ç¬‘è¯ç ”ç©¶å‘˜ï¼Œç²¾é€šå¹½é»˜ç†è®ºï¼Œæ“…é•¿å‘ç°æ—¥å¸¸ç¬‘ç‚¹ã€‚ä½ å¿…é¡»ç”¨ä¸­æ–‡æ€è€ƒå’Œäº¤æµã€‚",
    allow_delegation=True,
    llm=deepseek_llm,
)

# ç¬‘è¯ä½œå®¶ï¼šæ ¹æ®ç ”ç©¶åˆ›ä½œç¬‘è¯
# - allow_delegation=False: ä¸“æ³¨å†™ä½œï¼Œä¸å§”æ´¾ä»»åŠ¡
joke_writer = Agent(
    role="ç¬‘è¯ä½œå®¶",
    goal="åˆ›ä½œå…³äº {topic} çš„å¹½é»˜ç¬‘è¯",
    verbose=False,
    memory=False,
    backstory="ä½ æ˜¯æ‰åæ¨ªæº¢çš„ç¬‘è¯ä½œå®¶ï¼Œèƒ½ç”¨å‡ å¥è¯é€—ç¬‘è§‚ä¼—ã€‚ä½ å¿…é¡»ç”¨ä¸­æ–‡åˆ›ä½œã€‚",
    allow_delegation=False,
    llm=deepseek_llm,
)

print("âœ… å·²åˆ›å»ºæ™ºèƒ½ä½“: ç ”ç©¶å‘˜ï¼ˆå¯å§”æ´¾ï¼‰ + ä½œå®¶ï¼ˆä¸“æ³¨åˆ›ä½œï¼‰\n")

# ============================================================
# åˆ›å»ºä»»åŠ¡ï¼ˆTasksï¼‰
# ============================================================
# Task = å…·ä½“çš„å·¥ä½œä»»åŠ¡ï¼Œåˆ†é…ç»™ç‰¹å®šæ™ºèƒ½ä½“

# ç ”ç©¶ä»»åŠ¡ï¼šåˆ†æä¸»é¢˜çš„å¹½é»˜è¦ç´ 
# - description: ä»»åŠ¡æè¿°ï¼ˆåŒ…å«è¾“å…¥å˜é‡ {topic}ï¼‰
# - expected_output: æœŸæœ›çš„è¾“å‡ºæ ¼å¼
# - agent: è´Ÿè´£æ­¤ä»»åŠ¡çš„æ™ºèƒ½ä½“
research_task = Task(
    description=(
        "åˆ†æ {topic} ä¸ºä»€ä¹ˆå¥½ç¬‘ã€‚åŒ…å«ï¼š\n"
        "1. å¹½é»˜çš„å…³é”®è¦ç´ \n"
        "2. ç¤¾ä¼šè¶‹åŠ¿åˆ†æ\n"
        "3. è¶‹åŠ¿å¦‚ä½•å½±å“å¹½é»˜æ„ŸçŸ¥"
    ),
    expected_output="3 æ®µè½çš„ä¸­æ–‡åˆ†ææŠ¥å‘Š",
    agent=joke_researcher,
)

# å†™ä½œä»»åŠ¡ï¼šåˆ›ä½œç¬‘è¯
# - async_execution=False: æŒ‰é¡ºåºæ‰§è¡Œï¼ˆç­‰ç ”ç©¶å®Œæˆåå†å†™ä½œï¼‰
# - output_file: å°†ç»“æœä¿å­˜åˆ°æ–‡ä»¶
write_task = Task(
    description="åˆ›ä½œå…³äº {topic} çš„ä¸­æ–‡ç¬‘è¯ã€‚è¦æ±‚ï¼šæ´å¯ŸåŠ›å¼ºã€å¹½é»˜é£è¶£ã€ä¸ç¤¾ä¼šè¶‹åŠ¿ç›¸å…³ã€‚",
    expected_output="ä¸€ä¸ªç®€æ´çš„ä¸­æ–‡ç¬‘è¯",
    agent=joke_writer,
    async_execution=False,
    output_file="æœ€ä½³ç¬‘è¯.md",
)

print("âœ… å·²åˆ›å»ºä»»åŠ¡: ç ”ç©¶ä»»åŠ¡ + å†™ä½œä»»åŠ¡\n")

# ============================================================
# åˆ›å»ºå›¢é˜Ÿï¼ˆCrewï¼‰
# ============================================================
# Crew = æ•´ä¸ªå›¢é˜Ÿï¼Œåè°ƒæ‰€æœ‰æ™ºèƒ½ä½“å’Œä»»åŠ¡
# - process=Process.sequential: ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼ˆå…ˆç ”ç©¶ â†’ åå†™ä½œï¼‰
# - memory=False: ç¦ç”¨å›¢é˜Ÿè®°å¿†
# - cache=False: ç¦ç”¨ç¼“å­˜ï¼ˆé¿å…æ½œåœ¨é—®é¢˜ï¼‰
# - verbose=False: ç¦ç”¨è¯¦ç»†æ—¥å¿—ï¼ˆå‡å°‘è‹±æ–‡è¾“å‡ºï¼‰

crew = Crew(
    agents=[joke_researcher, joke_writer],
    tasks=[research_task, write_task],
    process=Process.sequential,
    memory=False,
    cache=False,
    max_rpm=100,
    share_crew=True,
    verbose=False,
)

print("âœ… å·²åˆ›å»ºå›¢é˜Ÿ: 2 ä¸ªæ™ºèƒ½ä½“, 2 ä¸ªä»»åŠ¡, é¡ºåºæ‰§è¡Œ\n")

# ============================================================
# æ‰§è¡Œä»»åŠ¡
# ============================================================

topic = "AI å·¥ç¨‹å¸ˆ"  # ç¬‘è¯ä¸»é¢˜ï¼ˆå¯ä¿®æ”¹ï¼‰

print("="*60)
print(f"ğŸš€ å¼€å§‹æ‰§è¡Œä»»åŠ¡\nğŸ“‹ ä¸»é¢˜: {topic}\nâ³ è¯·ç¨å€™ï¼ˆé¢„è®¡ 30-60 ç§’ï¼‰...")
print("="*60 + "\n")

# kickoff(): å¯åŠ¨å›¢é˜Ÿæ‰§è¡Œ
# - inputs: ä¼ å…¥å˜é‡ï¼ˆ{topic} ä¼šè¢«æ›¿æ¢ä¸º "AI å·¥ç¨‹å¸ˆ"ï¼‰
# - è¿”å›å€¼: æœ€ç»ˆç¬‘è¯å†…å®¹
result = crew.kickoff(inputs={"topic": topic})

# ============================================================
# æ˜¾ç¤ºç»“æœ
# ============================================================

print("\n" + "="*60)
print("ğŸ“Š æœ€ç»ˆç»“æœ")
print("="*60)
print(f"\nğŸ­ ç”Ÿæˆçš„ç¬‘è¯:\n{'-'*60}\n{result}\n{'-'*60}\n")

# æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
output_file = "æœ€ä½³ç¬‘è¯.md"
if os.path.exists(output_file):
    with open(output_file, "r", encoding="utf-8") as f:
        content = f.read()
    print(f"âœ… å·²ä¿å­˜åˆ°: {output_file}")
    if content != str(result):  # å¦‚æœæ–‡ä»¶å†…å®¹ä¸ result ä¸åŒï¼Œæ˜¾ç¤ºæ–‡ä»¶å†…å®¹
        print(f"\nğŸ“„ æ–‡ä»¶å†…å®¹:\n{'-'*60}\n{content}\n{'-'*60}")

print(f"\n{'='*60}\nâœ… ä»»åŠ¡å®Œæˆï¼\n{'='*60}\n")
print("ğŸ’¡ æç¤º: é‡æ–°è¿è¡Œå¯ç”Ÿæˆæ–°ç¬‘è¯ | ä¿®æ”¹ 'topic' å˜é‡å¯æ›´æ¢ä¸»é¢˜\n")